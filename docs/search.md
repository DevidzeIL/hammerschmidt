# Поиск товаров (Fuzzy Search)

## Обзор

Система поиска использует PostgreSQL расширение `pg_trgm` для fuzzy search (поиск с учётом опечаток). Это позволяет находить товары даже при наличии ошибок в запросе.

## Технические детали

### Расширение PostgreSQL

Используется расширение `pg_trgm` (trigram matching):
- Включено через миграцию: `CREATE EXTENSION IF NOT EXISTS pg_trgm;`
- Созданы GIN индексы на полях `name` и `description` для быстрого поиска

### Алгоритм поиска

1. **Нормализация запроса:**
   - Приведение к нижнему регистру
   - Удаление лишних пробелов
   - Обрезка пробелов

2. **Основной поиск:**
   - Использует `similarity()` и `word_similarity()` функции из `pg_trgm`
   - Оператор `%` для trigram matching
   - `ILIKE` как fallback для точных совпадений
   - Поиск по полям: `name` и `description`

3. **Транслитерация (fallback):**
   - Если результатов нет, пробуется замена латиницы на кириллицу
   - Частые замены: `a→а`, `e→е`, `o→о`, `p→р`, `c→с`, и т.д.
   - Повторный поиск с транслитерированным запросом

4. **Ранжирование:**
   - Результаты сортируются по `score` (similarity) по убыванию
   - Затем по алфавиту (`name ASC`)

### Порог similarity

**Константа:** `TRGM_THRESHOLD = 0.18`

Это значение определяет минимальный порог схожести для включения результата в выдачу.

**Как настроить:**

1. Откройте `app/api/public/products/route.ts`
2. Найдите константу `TRGM_THRESHOLD`
3. Измените значение (обычно в диапазоне 0.15–0.25):
   - **Меньше значение (0.15)** → больше результатов, но больше "шума"
   - **Больше значение (0.25)** → меньше результатов, но более точные

**Рекомендации:**
- Для каталога ~100 товаров: `0.18` (текущее значение) обычно оптимально
- Если слишком много нерелевантных результатов → увеличьте до `0.20-0.22`
- Если не находит очевидные совпадения → уменьшите до `0.15-0.16`

### Индексы

Созданы следующие индексы:
- `product_name_trgm_idx` - GIN индекс на `lower(name)`
- `product_description_trgm_idx` - GIN индекс на `lower(description)`

Индексы автоматически создаются при применении миграции.

## API Endpoint

### GET /api/public/products

**Параметры:**
- `q` (string, optional) - поисковый запрос
- `limit` (number, default: 24, max: 100) - количество результатов
- `offset` (number, default: 0, max: 5000) - смещение для пагинации
- `activeOnly` (boolean, default: true) - только активные товары

**Примеры:**

```bash
# Обычный список
GET /api/public/products?limit=24

# Поиск
GET /api/public/products?q=ведро%2012л

# С пагинацией
GET /api/public/products?q=пленка&limit=12&offset=12
```

**Ответ:**

```json
{
  "items": [...],
  "total": 5,
  "q": "ведро 12л",
  "suggestion": "ведро 12 л",  // опционально, если была транслитерация
  "debug": {                    // только в development
    "mode": "trgm",
    "threshold": 0.18
  }
}
```

## Примеры запросов

### Устойчивость к опечаткам

- `"vedro 12l"` → найдёт "Ведро строительное 12л"
- `"вдро 12"` → найдёт "Ведро строительное 12л"
- `"ведр 12л"` → найдёт "Ведро строительное 12л"
- `"пленка 100мкм"` → найдёт "Пленка с печатью 100 мкм"

### Транслитерация

- `"vedro"` → автоматически попробует `"ведро"`
- `"plenka"` → автоматически попробует `"пленка"`

## Производительность

- Индексы GIN обеспечивают быстрый поиск даже на больших каталогах
- Рекомендуется для каталогов до ~10,000 товаров
- Для больших каталогов (>50,000) может потребоваться оптимизация или переход на специализированные решения (Elasticsearch, Meilisearch)

## Ограничения

- Максимальная длина запроса: 64 символа
- Максимум результатов: 100 за запрос
- Максимальное смещение: 5000
- Минимальная длина запроса для fuzzy search: 2 символа

## Отладка

В режиме development (`NODE_ENV=development`) ответ включает поле `debug` с информацией о режиме поиска и пороге.

## Миграция

Применение миграции:

```bash
pnpm prisma migrate dev
```

Или вручную через SQL:

```sql
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE INDEX IF NOT EXISTS product_name_trgm_idx ON "Product" USING gin (lower(name) gin_trgm_ops);
CREATE INDEX IF NOT EXISTS product_description_trgm_idx ON "Product" USING gin (lower(description) gin_trgm_ops);
```
